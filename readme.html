<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#simple-profiles">Simple Profiles</a><ul>
<li><a href="#user-interface">User Interface</a></li>
<li><a href="#high-level-logical-flow">High level logical flow</a><ul>
<li><a href="#at-package-runtime">At package runtime:</a></li>
<li><a href="#procedure-list">Procedure list</a></li>
<li><a href="#table-list">Table list</a></li>
<li><a href="#changes-to-existing-package-runtime">Changes to existing package runtime</a></li>
</ul></li>
</ul></li>
</ul>
</div>
<h1 id="simple-profiles">Simple Profiles</h1>
<h2 id="user-interface">User Interface</h2>
<p>TODO see issues.</p>
<h2 id="high-level-logical-flow">High level logical flow</h2>
<ul>
<li>C# app is a ran to populate/update <code>Map.PackageTable</code> <a href="https://github.com/grahamcrowell/SqlServerUtilities">see SqlServerUtilities</a></li>
</ul>
<h3 id="at-package-runtime">At package runtime:</h3>
<p>Package runs as usual at end of package <code>DQMF.dbo.SetAuditPkgExecution</code> is called with <code>@pIsProcessStart = 0</code> and <code>AutoTest.dbo.uspAutoTestPackage</code> is called:</p>
<ol style="list-style-type: decimal">
<li><code>AutoTest.dbo.uspProfilePackageTables</code> is called</li>
</ol>
<p>For each table in <code>Map.PackageTable</code> for this package <code>AutoTest.dbo.uspProfileTable</code> is called thereby populating: <code>AutoTest.dbo.TableProfile</code>, <code>AutoTest.dbo.ColumnProfile</code>, and <code>AutoTest.dbo.ColumnHistogram</code> are populated.</p>
<ol start="2" style="list-style-type: decimal">
<li><p><code>AutoTest.dbo.uspUpdateAlerts</code> is called and <code>AutoTest.dbo.Alert</code> table is popualted.</p></li>
<li><p><code>AutoTest.dbo.uspSendAlertEmails</code> is called</p></li>
</ol>
<p>If rows exist in <code>AutoTest.dbo.Alert</code> for this package execution single summary email is sent with</p>
<h3 id="procedure-list">Procedure list</h3>
<h4 id="autotest.dbo.uspprofiletable"><code>AutoTest.dbo.uspProfileTable</code></h4>
<p>For a given table: Profiles a single table and populates profile tables: <code>AutoTest.dbo.TableProfile</code>, <code>AutoTest.dbo.ColumnProfile</code>, and <code>AutoTest.dbo.ColumnHistogram</code></p>
<h4 id="autotest.dbo.uspprofilepackagetables"><code>AutoTest.dbo.uspProfilePackageTables</code></h4>
<p>For a given package: Calls <code>AutoTest.dbo.uspProfileTable</code> for each table in <code>Map.PackageTable</code></p>
<h4 id="autotest.dbo.uspupdatealerts"><code>AutoTest.dbo.uspUpdateAlerts</code></h4>
<p>Merge statement is executed to update/insert <code>AutoTest.dbo.Alert</code> from profile tables.</p>
<h4 id="autotest.dbo.uspsendalertemails"><code>AutoTest.dbo.uspSendAlertEmails</code></h4>
<p>For a given package execution: <code>AutoTest.dbo.Alert</code> is queried and if alerts are found an alert email is sent using <code>msdb.dbo.sp_send_dbmail</code></p>
<h3 id="table-list">Table list</h3>
<h4 id="profile-tables">Profile tables</h4>
<p>logging tables that profile results.</p>
<ul>
<li><code>AutoTest.dbo.TableProfile</code> one row per package execution per table per profile execution</li>
<li><code>AutoTest.dbo.ColumnProfile</code> one row per column of a table profiled</li>
<li><code>AutoTest.dbo.ColumnHistogram</code> one row per column value of a table profiled</li>
</ul>
<h4 id="control-tables">Control tables</h4>
<ul>
<li><code>AutoTest.dbo.Alert</code> controls content of alert emails. one row per alerted violation. a violation can be in terms of a profiled table, column or a column value.</li>
<li><code>Map.PackageTable</code> one row per table in a package data flow task. indirectly controls which tables are profiled at runtime (see <code>AutoTest.dbo.vwPackageProfileTable</code>).</li>
<li><code>AutoTest.dbo.vwPackageProfileTable</code> controls which tables are profiled at package runtime. queries <code>Map.PackageTable</code>. one row per table per table to be profiled.</li>
</ul>
<h3 id="changes-to-existing-package-runtime">Changes to existing package runtime</h3>
<ul>
<li><p>The existing <code>DQMF.dbo.SetAuditPkgExecution</code> proc is extended to call new proc <code>AutoTest.dbo.uspProfilePackage</code> when <code>@pIsProcessStart = 0</code></p></li>
<li><code>AutoTest.dbo.uspProfileTable</code> populates 3 profile tables
<ul>
<li><code>AutoTest.dbo.TableProfile</code>
<ul>
<li><code>TableProfileDate</code></li>
<li><code>DatabaseName</code></li>
<li><code>SchemaName</code></li>
<li><code>TableName</code></li>
<li><code>RecordCount</code></li>
<li><code>PkgExecKey</code></li>
</ul></li>
<li><code>AutoTest.dbo.ColumnProfile</code>
<ul>
<li><code>ColumnProfileDate</code></li>
<li><code>DatabaseName</code></li>
<li><code>TableName</code></li>
<li><code>ColumnName</code></li>
<li><code>DistinctCount</code></li>
<li><code>PkgExecKey</code></li>
</ul></li>
<li><code>AutoTest.dbo.ColumnHistogram</code>
<ul>
<li><code>ColumnHistogramDate</code></li>
<li><code>DatabaseName</code></li>
<li><code>TableName</code></li>
<li><code>ColumnName</code></li>
<li><code>ColumnValue</code></li>
<li><code>ValueCount</code></li>
<li><code>PkgExecKey</code></li>
</ul></li>
</ul></li>
</ul>
</body>
</html>
